trigger:
  branches:
    include:
      - master
  paths:
    exclude:
      - src/_drafts
      - README.md

jobs:
  - job: build
    pool: Default
    steps:
      - task: UseRubyVersion@0
        inputs:
          versionSpec: '>= 2.5'
      
      - script: |
          gem install jekyll bundler
        displayName: 'install jekyll'
          
      - script: |
          cd src
          bundle install
          jekyll build
        displayName: 'jekyll build'
          
      - task: CopyFiles@2
        displayName: 'Copy files to staging'
        inputs:
          SourceFolder: 'src/_site'
          TargetFolder: '$(Build.ArtifactStagingDirectory)'
      
      - task: PublishBuildArtifacts@1
        displayName: 'Publish build artifact'
        inputs:
          pathtoPublish: '$(Build.ArtifactStagingDirectory)'
          artifactName: site
    
  - job: deploy
    pool: Default
    dependsOn: build
    condition: succeeded()
    steps:
      # download the artifact drop from the previous job
      - task: DownloadBuildArtifacts@0
        inputs:
          artifactName: site
          downloadPath: '$(System.ArtifactsDirectory)'

      # Copy files to Azure Blob Storage
      - task: AzureCLI@2
        displayName: Copy data to storage account
        inputs:
          azureSubscription: arm-service-connection
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
              az storage blob upload-batch \
                --destination \$web \
                --account-name "blogpersonalstorage" \
                --source "$(System.ArtifactsDirectory)/site"

      # Purge CDN to update content
      - task: AzureCLI@2
        displayName: Purge CDN contents
        inputs:
          azureSubscription: arm-service-connection
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
              az cdn endpoint purge \
              --name robkrollblogcdn \
              --profile-name blog-personal-cdn \
              --resource-group blog-personal \
              --content-paths '/*'
